name: goreleaser

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.calculate-version.outputs.version }}
      tag_name: ${{ steps.calculate-version.outputs.tag_name }}

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Fetch all tags
      run: git fetch --force --tags
    
    - name: Set up Go
      uses: actions/setup-go@v3
      with:
          go-version: 1.19
    
    - uses: crazy-max/ghaction-import-gpg@v5
      id: import_gpg
      with:
        gpg_private_key: ${{ secrets.OCTOPUS_GPG_PRIVATE_KEY }}
        passphrase: ${{ secrets.OCTOPUS_GPG_PASSPHRASE }}
    
    - name: Run GoReleaser
      id: goreleaser-release
      uses: goreleaser/goreleaser-action@v3
      with:
        version: latest
        args: release --rm-dist
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GPG_FINGERPRINT: ${{ steps.import_gpg.outputs.fingerprint }}
        GPG_PASSWORD: ${{ secrets.OCTOPUS_GPG_PASSPHRASE }}

    - name: Calculate version
      id: calculate-version
      run: |
        tag_name=${{ fromJson(steps.goreleaser-release.outputs.metadata).tag }}
        version=${{ fromJson(steps.goreleaser-release.outputs.metadata).version }}
        echo "::set-output name=tag_name::$tag_name"
        echo "::set-output name=version::$version"

    - uses: actions/upload-artifact@v3
      with:
        name: artifacts
        path: |
          dist/*.zip
          dist/*.tar.gz
          dist/*.rpm
          dist/*.deb

  msi:
    needs: goreleaser
    runs-on: windows-latest
    outputs:
      msi_file: ${{ steps.buildmsi.outputs.msi }}

    steps:
    - uses: actions/checkout@v3

    - uses: actions/download-artifact@v3
      with:
        name: artifacts
        path: artifacts/

    - name: Extract octopus.exe
      id: extract_exe
      shell: bash
      run: |
        cp ./artifacts/*windows_amd64.zip .
        printf "::set-output name=zip::%s\n" *.zip
        unzip -o *.zip && rm -v *.zip

    - name: Setup MSBuild
      id: setupmsbuild
      uses: microsoft/setup-msbuild@v1.0.3

    - name: Build MSI
      id: buildmsi
      shell: bash
      env:
        ZIP_FILE: ${{ steps.extract_exe.outputs.zip }}
        MSBUILD_PATH: ${{ steps.setupmsbuild.outputs.msbuildPath }}
      run: |
        name="$(basename "$ZIP_FILE" ".zip")"
        version="$(echo -e ${{ needs.goreleaser.outputs.version }} | sed 's/-.*$//')"
        "${MSBUILD_PATH}\MSBuild.exe" ./build/windows/octopus.wixproj -p:SourceDir="$PWD" -p:OutputPath="$PWD" -p:OutputName="$name" -p:ProductVersion="$version"

    - name: Install AzureSignTool
      run: dotnet tool install --global AzureSignTool

    - name: Sign MSI
      env:
        MSI_FILE: ${{ steps.buildmsi.outputs.msi }}
      shell: powershell
      run: |
        $timestampurl = (
            "http://timestamp.comodoca.com/rfc3161",
            "http://timestamp.globalsign.com/tsa/r6advanced1", #https://support.globalsign.com/code-signing/code-signing-windows-7-8-and-10,
            "http://timestamp.digicert.com", #https://knowledge.digicert.com/solution/SO912.html
            "http://timestamp.apple.com/ts01", #https://gist.github.com/Manouchehri/fd754e402d98430243455713efada710
            "http://tsa.starfieldtech.com",
            "http://www.startssl.com/timestamp",
            "http://timestamp.verisign.com/scripts/timstamp.dll",
            "http://timestamp.globalsign.com/scripts/timestamp.dll",
            "https://rfc3161timestamp.globalsign.com/advanced"
        )

        $ex = $null
        $signSuccessful = $false

        foreach ($url in $timestampurl) {
          Write-Host "Signing and timestamping with server $url"
          try {
            & AzureSignTool sign `
              -kvu "${{ secrets.AZURE_KEYVAULT_URL }}" `
              -kvt ${{ secrets.AZURE_KEYVAULT_TENANT_ID }} `
              -kvi "${{ secrets.AZURE_KEYVAULT_CLIENT_ID }}" `
              -kvs "${{ secrets.AZURE_KEYVAULT_CLIENT_SECRET }}" `
              -kvc ${{ secrets.AZURE_KEYVAULT_CERTIFICATE_NAME }} `
              -d "Octopus CLI" `
              -du "https://octopus.com" `
              -tr $url `
              -v `
              $env:MSI_FILE

            $signSuccessful = $true
          }
          catch {
            $ex = $_
          }

          if ($signSuccessful) { break }
        }

        if (-not $signSuccessful) {
          Write-Error $ex
          exit 1
        }

    - name: Upload MSI
      shell: bash
      env:
        MSI_FILE: ${{ steps.buildmsi.outputs.msi }}
        GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
      if: "!contains(needs.goreleaser.outputs.version, '-')" # skip prereleases
      run: gh release upload "${{ needs.goreleaser.outputs.tag_name }}" "$MSI_FILE"

    - uses: actions/upload-artifact@v3
      with:
        name: artifacts
        path: ${{ steps.buildmsi.outputs.msi }}

  generate-packages:
    needs: [goreleaser, msi]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - uses: actions/checkout@v3
      with:
        repository: OctopusDeploy/linux-package-feeds
        token: ${{ secrets.INTEGRATIONS_FNM_BOT_TOKEN }}
        path: linux-package-feeds-repo

    - run: |
        ln -s linux-package-feeds-repo/source linux-package-feeds

    - uses: actions/download-artifact@v3
      with:
        name: artifacts
        path: artifacts/

    - name: Download nuget.exe
      run: curl -o ./nuget.exe https://dist.nuget.org/win-x86-commandline/latest/nuget.exe

    - name: Create Chocolatey package
      env:
        MSI_FILE: ${{ needs.msi.outputs.msi_file }}
      run: |
        cp artifacts/$(basename "${MSI_FILE//\\//}") build/tools
        mono nuget.exe pack ./build/cli.nuspec -p:version=${{ needs.goreleaser.outputs.version }} -OutputDirectory artifacts/

    - name: Compress packages
      run: |
        mkdir artifacts/linux-packages
        cp artifacts/*.deb artifacts/*.rpm artifacts/linux-packages
        cp linux-package-feeds/publish-*.sh artifacts/linux-packages

        zip -rj artifacts/octopus-cli.${{ needs.goreleaser.outputs.version }}.zip /
          artifacts/*.nupkg \
          artifacts/linux-packages/* \
          artifacts/*macOS*amd64.tar.gz

    - uses: actions/upload-artifact@v3
      with:
        name: octopus-cli.${{ needs.goreleaser.outputs.version }}
        path: artifacts/octopus-cli.${{ needs.goreleaser.outputs.version }}.zip

  publish:
    needs: generate-packages
    runs-on: ubuntu-latest
    env:
      OCTOPUS_API_KEY: ${{ secrets.OCTOPUS_API_KEY }}
      OCTOPUS_HOST: ${{ secrets.OCTOPUS_URL }}      
      OCTOPUS_CLI_SERVER: ${{ secrets.OCTOPUS_URL }}
      OCTOPUS_CLI_API_KEY: ${{ secrets.OCTOPUS_API_KEY }}

    steps:
    - uses: actions/download-artifact@v3
      with:
        name: octopus-cli.${{ needs.goreleaser.outputs.version }}

    - name: Install Octopus CLI 🐙
      uses: OctopusDeploy/install-octopus-cli-action@v1
      with:
        version: latest

    - name: Push a package to Octopus Deploy 🐙
      uses: OctopusDeploy/push-package-action@v2
      with:
        space: Integrations
        packages: octopus-cli.${{ needs.goreleaser.outputs.version }}.zip

    - name: Fetch Release Notes
      id: fetch-release-notes
      if: "!contains(needs.goreleaser.outputs.version, '-')"
      run: |
        echo "::debug::${{github.event_name}}"
        OUTPUT_FILE="release_notes.txt"
        gh view release "${{ needs.goreleaser.outputs.tag_name }}" --jq '.body' --json 'body' | sed 's#\r#  #g' > $OUTPUT_FILE
        echo "::set-output name=release-note-file::$OUTPUT_FILE"

    - name: Create a release in Octopus Deploy 🐙
      uses: OctopusDeploy/create-release-action@v2
      if: "!contains(needs.goreleaser.outputs.version, '-')"
      with:
        space: Integrations
        project: 'cli'
        package_version: ${{ needs.goreleaser.outputs.version }}
        packages: '*:NuGet.CommandLine:4.4.1'
        release_notes_file: ${{ steps.fetch-release-notes.outputs.release-note-file || ''}}
        git_ref: ${{ (github.ref_type == 'tag' && github.event.repository.default_branch ) || (github.head_ref || github.ref) }}
        git_commit: ${{ github.event.after || github.event.pull_request.head.sha }}
